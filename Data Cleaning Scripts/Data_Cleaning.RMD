---
title: "UWATX- 211 Explorer Data Cleaning"
author: "Ethan Tenison"
date: "8/11/2019"
output: html_document
---

```{r libraries, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse) 
library(dplyr) #data manipulation
library(janitor) #data cleaning
library(scales) #to convert to percent 
library(lubridate) #converting time 
library(readr) #reading in data
library(openxlsx) #reading excel sheets 
```

## Demographic Information 

```{r}
#2016

demography_2016<- read.csv("./ACS_Data/ACS_16_5YR_DP05_with_ann.csv")

#data cleaning 
names(demography_2016) <- as.matrix(demography_2016[1, ])
demography_2016 <- demography_2016[-1, ]
demography_2016 <- clean_names(demography_2016)
demography_2016 <- rename(demography_2016, zipcode = id2)
demography_2016 <- demography_2016 %>% mutate_each(funs(as.character))
demography_2016 <- demography_2016 %>% mutate_each(funs(as.numeric))
demography_2016 <- filter(demography_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT


demography_2016 <- select(demography_2016, zipcode, contains("latino"), -(contains("margin")), -(contains("sex")))
demography_2016 <- select(demography_2016, zipcode, percent_hispanic_or_latino_and_race_total_population_hispanic_or_latino_of_any_race
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_white_alone
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_black_or_african_american_alone
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_asian_alone
)

demography_2016 <- rename(demography_2016, percent_hispanic = percent_hispanic_or_latino_and_race_total_population_hispanic_or_latino_of_any_race
                          ,percent_white_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_white_alone
                          ,percent_black_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_black_or_african_american_alone
                          ,percent_asian_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_asian_alone
)

#setting the date 
date2016 <- ymd(20160101)
demography_2016 <- mutate(demography_2016, date = date2016)


#2017

demography_2017<- read.csv("./ACS_Data/ACS_17_5YR_DP05_with_ann.csv")
names(demography_2017) <- as.matrix(demography_2017[1, ])
demography_2017 <- demography_2017[-1, ]
demography_2017 <- clean_names(demography_2017)
demography_2017 <- rename(demography_2017, zipcode = id2)
demography_2017 <- demography_2017 %>% mutate_each(funs(as.character))
demography_2017 <- demography_2017 %>% mutate_each(funs(as.numeric))
demography_2017 <- filter(demography_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

demography_2017 <- select(demography_2017, zipcode, contains("latino"), -(contains("margin")), -(contains("sex")))
demography_2017 <- select(demography_2017, zipcode, percent_hispanic_or_latino_and_race_total_population_hispanic_or_latino_of_any_race
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_white_alone
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_black_or_african_american_alone
                          ,percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_asian_alone
)

demography_2017 <- rename(demography_2017, percent_hispanic = percent_hispanic_or_latino_and_race_total_population_hispanic_or_latino_of_any_race
                          ,percent_white_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_white_alone
                          ,percent_black_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_black_or_african_american_alone
                          ,percent_asian_alone = percent_hispanic_or_latino_and_race_total_population_not_hispanic_or_latino_asian_alone
)

date2017 <- ymd(20170101)
demography_2017 <- mutate(demography_2017, date = date2017)


#binding rows
demography <- bind_rows(demography_2016, demography_2017)
demography$percent_hispanic <- paste0(demography$percent_hispanic, '%')
demography$percent_white_alone <- paste0(demography$percent_white_alone, '%')
demography$percent_black_alone <- paste0(demography$percent_black_alone, '%')
demography$percent_asian_alone <- paste0(demography$percent_asian_alone, '%')

#saving data 
saveRDS(demography, file = "./R Objects/demographics.RDS")
```

##Education 

```{r}
#2016
education_2016<- read.csv("./ACS_Data/ACS_16_5YR_B15003_with_ann.csv")
education_2016 <- select(education_2016, GEO.id2, starts_with("HD01"))
names(education_2016) <- as.matrix(education_2016[1, ])
education_2016 <- education_2016[-1, ]
education_2016 <- clean_names(education_2016)
education_2016 <- rename(education_2016, zipcode = id2)
education_2016 <- education_2016 %>% mutate_each(funs(as.character))
education_2016 <- education_2016 %>% mutate_each(funs(as.numeric))
education_2016 <- filter(education_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

education_2016 <- mutate(education_2016, less_than_highschool = rowSums(education_2016[,3:17]),
                         high_school_GED = estimate_total_regular_high_school_diploma + estimate_total_ged_or_alternative_credential
                         ,associates_some_college = estimate_total_some_college_1_or_more_years_no_degree +
                           estimate_total_some_college_less_than_1_year + estimate_total_associates_degree , bachelors_plus = 
                           estimate_total_bachelors_degree + estimate_total_masters_degree + estimate_total_professional_school_degree +
                           estimate_total_doctorate_degree)
education_2016 <- education_2016[,-(3:26)]

#setting the date 
year2016 <- ymd(20160101)
education_2016 <- mutate(education_2016, date = year2016) 

#2017
education_2017<- read.csv("./ACS_Data/ACS_17_5YR_B15003_with_ann.csv")
education_2017 <- select(education_2017, GEO.id2, starts_with("HD01"))
names(education_2017) <- as.matrix(education_2017[1, ])
education_2017 <- education_2017[-1, ]
education_2017 <- clean_names(education_2017)
education_2017 <- rename(education_2017, zipcode = id2)
education_2017 <- education_2017 %>% mutate_each(funs(as.character))
education_2017 <- education_2017 %>% mutate_each(funs(as.numeric))
education_2017 <- filter(education_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

education_2017 <- mutate(education_2017, less_than_highschool = rowSums(education_2017[,3:17]),
                         high_school_GED = estimate_total_regular_high_school_diploma + estimate_total_ged_or_alternative_credential
                         ,associates_some_college = estimate_total_some_college_1_or_more_years_no_degree +
                           estimate_total_some_college_less_than_1_year + estimate_total_associates_degree , bachelors_plus = 
                           estimate_total_bachelors_degree + estimate_total_masters_degree + estimate_total_professional_school_degree +
                           estimate_total_doctorate_degree)
education_2017 <- education_2017[,-(3:26)]

#setting the date 
year2017 <- ymd(20170101)
education_2017 <- mutate(education_2017, date = year2017)  

#Binding the rows to create one dataset for educational_attainment 
education <- bind_rows(education_2016, education_2017)

#Transform the values to percents
education <- transmute(education,date, zipcode, estimate_total, percent_less_than_highschool = less_than_highschool/estimate_total,
                       percent_highschool_GED = high_school_GED/estimate_total, percent_associates_somecollege = 
                       associates_some_college/estimate_total, percent_bachelors_plus = bachelors_plus/estimate_total)

education$percent_less_than_highschool <- percent(education$percent_less_than_highschool)
education$percent_highschool_GED <- percent(education$percent_highschool_GED)
education$percent_associates_somecollege <- percent(education$percent_associates_somecollege)
education$percent_bachelors_plus <- percent(education$percent_bachelors_plus)
education <- select(education, -(estimate_total))

#save R object 
saveRDS(education, file = "./R Objects/education_attainment.RDS")

```

## Health Insurance

```{r}
#2016

insurance_2016<- read.csv("./ACS_Data/ACS_16_5YR_DP03_with_ann.csv")
names(insurance_2016) <- as.matrix(insurance_2016[1, ])
insurance_2016 <- insurance_2016[-1, ]
insurance_2016 <- clean_names(insurance_2016)
insurance_2016 <- rename(insurance_2016, zipcode = id2)
insurance_2016 <- insurance_2016 %>% mutate_each(funs(as.character))
insurance_2016 <- insurance_2016 %>% mutate_each(funs(as.numeric))
insurance_2016 <- filter(insurance_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT

insurance_2016 <- select(insurance_2016, zipcode, contains("health_insurance_coverage"), 
                         -(contains("margin")), -(contains("years")), -(contains("estimate")))
insurance_2016 <- insurance_2016[,-2]
names(insurance_2016) <- c("zipcode", "percent_with_insurance", "percent_with_private_insurance", 
                           "percent_with_public_insurance", "percent_with_no_insurance")

year2016 <- ymd(20160101)
insurance_2016 <- mutate(insurance_2016, date = year2016)  

#2017

insurance_2017<- read.csv("./ACS_Data/ACS_17_5YR_DP03_with_ann.csv")
names(insurance_2017) <- as.matrix(insurance_2017[1, ])
insurance_2017 <- insurance_2017[-1, ]
insurance_2017 <- clean_names(insurance_2017)
insurance_2017 <- rename(insurance_2017, zipcode = id2)
insurance_2017 <- insurance_2017 %>% mutate_each(funs(as.character))
insurance_2017 <- insurance_2017 %>% mutate_each(funs(as.numeric))
insurance_2017 <- filter(insurance_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

insurance_2017 <- select(insurance_2017, zipcode, contains("health_insurance_coverage"), 
                         -(contains("margin")), -(contains("years")), -(contains("estimate")))
insurance_2017 <- insurance_2017[,-2]
names(insurance_2017) <- c("zipcode", "percent_with_insurance", "percent_with_private_insurance", 
                           "percent_with_public_insurance", "percent_with_no_insurance")

year2017 <- ymd(20170101)
insurance_2017 <- mutate(insurance_2017, date = year2017)  


#binding rows
insurance <- bind_rows(insurance_2016, insurance_2017)
insurance$percent_with_insurance <- paste0(insurance$percent_with_insurance, '%')
insurance$percent_with_private_insurance <- paste0(insurance$percent_with_private_insurance, '%')
insurance$percent_with_public_insurance <- paste0(insurance$percent_with_public_insurance, '%')
insurance$percent_with_no_insurance <- paste0(insurance$percent_with_no_insurance, '%')

#save r Object
saveRDS(insurance, file = "./R Objects/health_insurance.RDS")

```


## Housing Units 

```{r}
#2016
housing_units_2016<- read.csv("./ACS_Data/ACS_16_5YR_DP04_with_ann.csv")
housing_units_2016 <- select(housing_units_2016, GEO.id2, HC01_VC03)
housing_units_2016 <- rename(housing_units_2016, zipcode = GEO.id2, housing_units = HC01_VC03)
housing_units_2016 <- housing_units_2016[2:1942,]
housing_units_2016 <- mutate(housing_units_2016, zipcode = as.numeric(as.character(zipcode)), 
                             housing_units = as.numeric(as.character(housing_units)))
housing_units_2016 <- filter(housing_units_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                 ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                 ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                 ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                 ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                 ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                 ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT
#setting the date 
year2016 <- ymd(20160101)
housing_units_2016 <- mutate(housing_units_2016, date = year2016)  

#2017
housing_units_2017<- read.csv("./ACS_Data/ACS_17_5YR_DP04_with_ann.csv")
housing_units_2017 <- select(housing_units_2017, GEO.id2, HC01_VC03)
housing_units_2017 <- rename(housing_units_2017, zipcode = GEO.id2, housing_units = HC01_VC03)
housing_units_2017 <- housing_units_2017[2:1942,]
housing_units_2017 <- mutate(housing_units_2017, zipcode = as.numeric(as.character(zipcode)), 
                             housing_units = as.numeric(as.character(housing_units)))
housing_units_2017 <- filter(housing_units_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                 ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                 ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                 ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                 ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                 ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                 ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
#setting the date 
year2017 <- ymd(20170101)
housing_units_2017 <- mutate(housing_units_2017, date = year2017)  

#Binding the rows to create one dataset  
housing_units <- bind_rows(housing_units_2016, housing_units_2017)

#save R object file 
saveRDS(housing_units, file = "./R Objects/total_housing_units.RDS")
```


## Median Rent
```{r}
#2016

medianRent_2016<- read.csv("./ACS_Data/ACS_16_5YR_B25064_with_ann.csv")
names(medianRent_2016) <- as.matrix(medianRent_2016[1, ])
medianRent_2016 <- medianRent_2016[-1, ]
medianRent_2016 <- clean_names(medianRent_2016)
medianRent_2016 <- rename(medianRent_2016, zipcode = id2)
medianRent_2016 <- medianRent_2016 %>% mutate_each(funs(as.character))
medianRent_2016 <- medianRent_2016 %>% mutate_each(funs(as.numeric))
medianRent_2016 <- filter(medianRent_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT

medianRent_2016 <- select(medianRent_2016, zipcode, estimate_median_gross_rent, 
                          -(contains("margin")), -(geography), -(id))

year2016 <- ymd(20160101)
medianRent_2016 <- mutate(medianRent_2016, date = year2016)  

#2017

medianRent_2017<- read.csv("./ACS_Data/ACS_17_5YR_B25064_with_ann.csv")
names(medianRent_2017) <- as.matrix(medianRent_2017[1, ])
medianRent_2017 <- medianRent_2017[-1, ]
medianRent_2017 <- clean_names(medianRent_2017)
medianRent_2017 <- rename(medianRent_2017, zipcode = id2)
medianRent_2017 <- medianRent_2017 %>% mutate_each(funs(as.character))
medianRent_2017 <- medianRent_2017 %>% mutate_each(funs(as.numeric))
medianRent_2017 <- filter(medianRent_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

medianRent_2017 <- select(medianRent_2017, zipcode, estimate_median_gross_rent, 
                          -(contains("margin")), -(geography), -(id))

year2017 <- ymd(20170101)
medianRent_2017 <- mutate(medianRent_2017, date = year2017)  


#binding rows
medianRent <- bind_rows(medianRent_2016, medianRent_2017)

#save R object 
saveRDS(medianRent, file = "./R Objects/median_rent.RDS")

```

## Median Home Value

```{r}

#2016
housing_median_price_2016<- read.csv("./ACS_Data/ACS_16_5YR_DP04_with_ann.csv")
housing_median_price_2016 <- select(housing_median_price_2016, GEO.id2, HC01_VC128)
housing_median_price_2016 <- rename(housing_median_price_2016, zipcode = GEO.id2, housing_median_price = HC01_VC128)
housing_median_price_2016 <- housing_median_price_2016[2:1942,]
housing_median_price_2016 <- mutate(housing_median_price_2016, zipcode = as.numeric(as.character(zipcode)), 
                                    housing_median_price = as.numeric(as.character(housing_median_price)))
housing_median_price_2016 <- filter(housing_median_price_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                               ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                               ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                               ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                               ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                               ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                               ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
year2016 <- ymd(20160101)
housing_median_price_2016 <- mutate(housing_median_price_2016, date = year2016)  

#2017
housing_median_price_2017<- read.csv("./ACS_Data/ACS_17_5YR_DP04_with_ann.csv")
housing_median_price_2017 <- select(housing_median_price_2017, GEO.id2, HC01_VC128)
housing_median_price_2017 <- rename(housing_median_price_2017, zipcode = GEO.id2, housing_median_price = HC01_VC128)
housing_median_price_2017 <- housing_median_price_2017[2:1942,]
housing_median_price_2017 <- mutate(housing_median_price_2017, zipcode = as.numeric(as.character(zipcode)), 
                                    housing_median_price = as.numeric(as.character(housing_median_price)))
housing_median_price_2017 <- filter(housing_median_price_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                               ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                               ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                               ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                               ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                               ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                               ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT
year2017 <- ymd(20170101)
housing_median_price_2017 <- mutate(housing_median_price_2017, date = year2017)  

#Binding the rows to create one dataset  
housing_median_price <- bind_rows(housing_median_price_2016, housing_median_price_2017)

#save r object
saveRDS(housing_median_price, file = "./R Objects/median_housing_price.RDS")

```

## Median Family Income 
```{r}
#2016

median_income_family_2016<- read.csv("./ACS_Data/ACS_16_5YR_B19126_with_ann.csv")
names(median_income_family_2016) <- as.matrix(median_income_family_2016[1, ])
median_income_family_2016 <- median_income_family_2016[-1, ]
median_income_family_2016 <- clean_names(median_income_family_2016)
median_income_family_2016 <- rename(median_income_family_2016, zipcode = id2)
median_income_family_2016 <- median_income_family_2016 %>% mutate_each(funs(as.character))
median_income_family_2016 <- median_income_family_2016 %>% mutate_each(funs(as.numeric))
median_income_family_2016 <- filter(median_income_family_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                               ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                               ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                               ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                               ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                               ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                               ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT


median_income_family_2016 <- select(median_income_family_2016, zipcode, 
                                    estimate_median_family_income_in_the_past_12_months_in_2016_inflation_adjusted_dollars_total)

median_income_family_2016 <- rename(median_income_family_2016, median_family_income =  
                                      estimate_median_family_income_in_the_past_12_months_in_2016_inflation_adjusted_dollars_total)

year2016 <- ymd(20160101)
median_income_family_2016 <- mutate(median_income_family_2016, date = year2016)

#2017

median_income_family_2017<- read.csv("./ACS_Data/ACS_17_5YR_B19126_with_ann.csv")
names(median_income_family_2017) <- as.matrix(median_income_family_2017[1, ])
median_income_family_2017 <- median_income_family_2017[-1, ]
median_income_family_2017 <- clean_names(median_income_family_2017)
median_income_family_2017 <- rename(median_income_family_2017, zipcode = id2)
median_income_family_2017 <- median_income_family_2017 %>% mutate_each(funs(as.character))
median_income_family_2017 <- median_income_family_2017 %>% mutate_each(funs(as.numeric))
median_income_family_2017 <- filter(median_income_family_2017, zipcode %in% c( 78705, 78617,78641,78645,78652,78653,78660,78701,78702
                                                                               ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                               ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                               ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                               ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                               ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                               ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

median_income_family_2017 <- select(median_income_family_2017, zipcode, 
                                    estimate_median_family_income_in_the_past_12_months_in_2017_inflation_adjusted_dollars_total)

median_income_family_2017 <- rename(median_income_family_2017, median_family_income =  
                                      estimate_median_family_income_in_the_past_12_months_in_2017_inflation_adjusted_dollars_total)


year2017 <- ymd(20170101)
median_income_family_2017 <- mutate(median_income_family_2017, date = year2017)


#binding rows
median_income_family <- bind_rows(median_income_family_2016, median_income_family_2017)

#saving data 
saveRDS(median_income_family, file = "./R Objects/median_family_income.RDS")

```

## Treemap Master 
This document shows every single 211 referral along with year,zip, age, gender, language, military status, and the name of the need. 

```{R}
#2016
icarol_2016 <- openxlsx::read.xlsx("./211 Data/2016 CNT iCarol Export.xlsx", 
                                   sheet = 1, startRow = 1, colNames = TRUE)

#2016renaming column headers and filtering for Travis country zipcodes
icarol_2016 <- clean_names(icarol_2016)

icarol_2016 <- filter(icarol_2016, zip_code
                      %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                             ,78703,78704,78719,78721,78722,78723,78724,78725
                             ,78727,78728,78730,78731,78732,78733,78734,78735
                             ,78736,78738,78739,78741,78742,78743,78744,78745
                             ,78746,78747,78748,78749,78750,78751,78752,78753
                             ,78754,78756,78757,78758,78759,78654,78610,78621
                             ,78615,78669,78737,78620,78726)) 

icarol_2016 <- filter(icarol_2016, call_type != "Transfer")
icarol_2016 <- filter(icarol_2016, call_type != "Disconnect")
icarol_2016 <- select(icarol_2016, age, zip_code, gender, preferred_language, military_branch, military_status, need_name)

#reassigning age into bins
for (i in 1:length(icarol_2016$age)){
  if(icarol_2016$age[i] <= 12){        
    icarol_2016$age[i] <- "Children (0-12)"               
  }
  else if(icarol_2016$age[i] >= 13 & icarol_2016$age[i] < 18){        
    icarol_2016$age[i] <- "Teens (13-18)"              
  }
  else if(icarol_2016$age[i] >= 18 & icarol_2016$age[i] <=  24){        
    icarol_2016$age[i] <- "Adults (18-24)"              
  }
  else if(icarol_2016$age[i] >= 25 & icarol_2016$age[i] <=  34){        
    icarol_2016$age[i] <- "Adults (25-34)"              
  }
  else if(icarol_2016$age[i] >= 35 & icarol_2016$age[i] <=  44){        
    icarol_2016$age[i] <- "Adults (35-44)"  
  }
  else if(icarol_2016$age[i] >= 45 & icarol_2016$age[i] <=  54){        
    icarol_2016$age[i] <- "Adults (45-54)"              
  }
  else if(icarol_2016$age[i] >= 55 & icarol_2016$age[i] <=  64){        
    icarol_2016$age[i] <- "Adults (55-64)"              
  }
  else if(icarol_2016$age[i] >= 65 & icarol_2016$age[i] <=  74){        
    icarol_2016$age[i] <- "Adults (65-74)"              
  }
  else if(icarol_2016$age[i] >= 75){        
    icarol_2016$age[i] <- "Adults (75+)"              
  }
}
#adding count variable and year 
icarol_2016 <- mutate(icarol_2016, count = 1)

date2016 <- ymd(20160101)
icarol_2016 <- mutate(icarol_2016, Year = date2016)
icarol_2016 <- rename(icarol_2016, zipcode = zip_code)

treemap_master16<- select(icarol_2016, Year, zipcode, age, gender, preferred_language,
                          military_branch, military_status, need_name,count)

#2017
icarol_2017 <- openxlsx::read.xlsx("./211 Data/2017 iCarol Export 1.3.18.xlsx", 
                                   sheet = 2, startRow = 1, colNames = TRUE)

icarol_2017 <- clean_names(icarol_2017)

icarol_2017 <- filter(icarol_2017, zip_code
                      %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                             ,78703,78704,78719,78721,78722,78723,78724,78725
                             ,78727,78728,78730,78731,78732,78733,78734,78735
                             ,78736,78738,78739,78741,78742,78743,78744,78745
                             ,78746,78747,78748,78749,78750,78751,78752,78753
                             ,78754,78756,78757,78758,78759,78654,78610,78621
                             ,78615,78669,78737,78620,78726)) 

icarol_2017 <- filter(icarol_2017, call_type != "Transfer")
icarol_2017 <- filter(icarol_2017, call_type != "Disconnect")
icarol_2017 <- select(icarol_2017, age, zip_code, gender, preferred_language, 
                      military_branch, military_status, need_name)

for (i in 1:length(icarol_2017$age)){
  if(icarol_2017$age[i] <= 12){        
    icarol_2017$age[i] <- "Children (0-12)"               
  }
  else if(icarol_2017$age[i] >= 13 & icarol_2017$age[i] < 18){        
    icarol_2017$age[i] <- "Teens (13-18)"              
  }
  else if(icarol_2017$age[i] >= 18 & icarol_2017$age[i] <=  24){        
    icarol_2017$age[i] <- "Adults (18-24)"              
  }
  else if(icarol_2017$age[i] >= 25 & icarol_2017$age[i] <=  34){        
    icarol_2017$age[i] <- "Adults (25-34)"              
  }
  else if(icarol_2017$age[i] >= 35 & icarol_2017$age[i] <=  44){        
    icarol_2017$age[i] <- "Adults (35-44)"  
  }
  else if(icarol_2017$age[i] >= 45 & icarol_2017$age[i] <=  54){        
    icarol_2017$age[i] <- "Adults (45-54)"              
  }
  else if(icarol_2017$age[i] >= 55 & icarol_2017$age[i] <=  64){        
    icarol_2017$age[i] <- "Adults (55-64)"              
  }
  else if(icarol_2017$age[i] >= 65 & icarol_2017$age[i] <=  74){        
    icarol_2017$age[i] <- "Adults (65-74)"              
  }
  else if(icarol_2017$age[i] >= 75){        
    icarol_2017$age[i] <- "Adults (75+)"              
  }
}
icarol_2017 <- mutate(icarol_2017, count = 1)

date2017 <- ymd(20170101)
icarol_2017 <- mutate(icarol_2017, Year = date2017)
icarol_2017 <- rename(icarol_2017, zipcode = zip_code)

treemap_master17<- select(icarol_2017, Year, zipcode, age, gender, preferred_language,
                          military_branch, military_status,need_name, count)
#binding and saving 
treemap_master <- bind_rows(treemap_master16, treemap_master17)

for (i in 1:length(treemap_master$military_branch)){
  if(is.na(treemap_master$military_branch[i])){        
    treemap_master$military_branch <- "Undetermined"               
  }
}


for (i in 1:length(treemap_master$military_status)){
  if(is.na(treemap_master$military_status[i])){        
    treemap_master$military_status[i] <- "Undetermined"               
  }
  else if(treemap_master$military_status[i] == "Did Not Ask"){        
    treemap_master$military_status[i] <- "Undetermined"              
  }
}

saveRDS(treemap_master, file = "./R Objects/treemap_master.RDS")

```

## Needs Zip treemap 
This document shows the sum of every type of referral by year, zipcode, and needs category. 
```{R}


#2016
icarol_2016 <- openxlsx::read.xlsx("./211 Data/2016 CNT iCarol Export.xlsx", 
                                   sheet = 1, startRow = 1, colNames = TRUE)

#2016renaming column headers and filtering for Travis country zipcodes
icarol_2016 <- clean_names(icarol_2016)

icarol_2016 <- filter(icarol_2016, zip_code
                      %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                             ,78703,78704,78719,78721,78722,78723,78724,78725
                             ,78727,78728,78730,78731,78732,78733,78734,78735
                             ,78736,78738,78739,78741,78742,78743,78744,78745
                             ,78746,78747,78748,78749,78750,78751,78752,78753
                             ,78754,78756,78757,78758,78759,78654,78610,78621
                             ,78615,78669,78737,78620,78726)) 

icarol_2016 <- filter(icarol_2016, call_type != "Transfer")
icarol_2016 <- filter(icarol_2016, call_type != "Disconnect")

#group by need name 

needs_zip_treemap16 <- icarol_2016 %>% group_by(zip_code, need_name) %>% tally()

#reformat data 

needs_zip_treemap16 <- rename(needs_zip_treemap16, zipcode = zip_code, value = n)
needs_zip_treemap16 <- mutate(needs_zip_treemap16, Year = 2016)


#2017
icarol_2017 <- openxlsx::read.xlsx("./211 Data/2017 iCarol Export 1.3.18.xlsx", sheet = 2, startRow = 1, colNames = TRUE)

icarol_2017 <- clean_names(icarol_2017)

icarol_2017 <- filter(icarol_2017, zip_code
                      %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                             ,78703,78704,78719,78721,78722,78723,78724,78725
                             ,78727,78728,78730,78731,78732,78733,78734,78735
                             ,78736,78738,78739,78741,78742,78743,78744,78745
                             ,78746,78747,78748,78749,78750,78751,78752,78753
                             ,78754,78756,78757,78758,78759,78654,78610,78621
                             ,78615,78669,78737,78620,78726)) 

icarol_2017 <- filter(icarol_2017, call_type != "Transfer")
icarol_2017 <- filter(icarol_2017, call_type != "Disconnect")

needs_zip_treemap17 <- icarol_2017 %>% group_by(zip_code, need_name) %>% tally()
needs_zip_treemap17 <- rename(needs_zip_treemap17, zipcode = zip_code, value = n)
needs_zip_treemap17 <- mutate(needs_zip_treemap17, Year = 2017)


#create one object and saving
needs_zip_treemap <- bind_rows(needs_zip_treemap16, needs_zip_treemap17)
needs_zip_treemap <- na.omit(needs_zip_treemap)
needs_zip_treemap <- filter(needs_zip_treemap, value >5)
needs_zip_treemap$Year <- as.character(needs_zip_treemap$Year)
needs_zip_treemap$value <- as.numeric(needs_zip_treemap$value)


needs_zip_treemap <- rename(needs_zip_treemap, "Zip Code" = zipcode, "Value" = value, 
                            "Needs Category" = need_name)




saveRDS(needs_zip_treemap, file = "./R Objects/needs_zip_treemap.RDS")


```

## Percent Below Poverty Level 
```{r}
#2016
poverty_status_2016 <- read.csv("./ACS_Data/ACS_16_5YR_S1701_with_ann.csv")
poverty_status_2016 <- select(poverty_status_2016, GEO.id2, HC03_EST_VC01)
poverty_status_2016 <- rename(poverty_status_2016, zipcode = GEO.id2, percent_below_poverty_level = HC03_EST_VC01)
poverty_status_2016 <- poverty_status_2016[2:1947,]
poverty_status_2016 <- mutate(poverty_status_2016, zipcode = as.numeric(as.character(zipcode)), 
                              percent_below_poverty_level = as.numeric(as.character(percent_below_poverty_level)))
poverty_status_2016 <- filter(poverty_status_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                   ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                   ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                   ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                   ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                   ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                   ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

year2016 <- ymd(20160101)
poverty_status_2016 <- mutate(poverty_status_2016, date = year2016)  

#2017pulling the csv file into the global environment
poverty_status_2017 <- read.csv("./ACS_Data/ACS_17_5YR_S1701_with_ann.csv")

#2017selecting meaningful columns
poverty_status_2017 <- select(poverty_status_2017, GEO.id2, HC03_EST_VC01)

#2017renaming column headers and filtering for Travis country zipcodes
poverty_status_2017 <- rename(poverty_status_2017, zipcode = GEO.id2, percent_below_poverty_level = HC03_EST_VC01)
poverty_status_2017 <- poverty_status_2017[2:1947,]
poverty_status_2017 <- mutate(poverty_status_2017, zipcode = as.numeric(as.character(zipcode)), 
                              percent_below_poverty_level = as.numeric(as.character(percent_below_poverty_level)))
poverty_status_2017 <- filter(poverty_status_2017, zipcode %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                                  ,78703,78704,78719,78721,78722,78723,78724,78725
                                                                  ,78727,78728,78730,78731,78732,78733,78734,78735
                                                                  ,78736,78738,78739,78741,78742,78743,78744,78745
                                                                  ,78746,78747,78748,78749,78750,78751,78752,78753
                                                                  ,78754,78756,78757,78758,78759,78654,78610,78621
                                                                  ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
#2017Adding a column for year 
year2017 <- ymd(20170101)
poverty_status_2017 <- mutate(poverty_status_2017, date = year2017) 
        

        
#Binding the rows to create one dataset for poverty status 
        poverty_status <- bind_rows(poverty_status_2016, poverty_status_2017)
        
#Save R object
        saveRDS(poverty_status, file = "./R Objects/percent_below_poverty.RDS")

```


## Percent Above 60 

```{r}
 #2016
        over60_2016<- read.csv("./ACS_Data/ACS_16_5YR_S0101_with_ann.csv")
        over60_2016 <- select(over60_2016, GEO.id2, HC02_EST_VC31)
        over60_2016 <- rename(over60_2016, zipcode = GEO.id2, percent_over60 = HC02_EST_VC31)
        over60_2016 <- over60_2016[2:1942,]
        over60_2016 <- mutate(over60_2016, zipcode = as.numeric(as.character(zipcode)), 
                              percent_over60 = as.numeric(as.character(percent_over60)))
        over60_2016 <- filter(over60_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
        year2016 <- ymd(20160101)
        over60_2016 <- mutate(over60_2016, date = year2016)
        
#2017
        over60_2017<- read.csv("./ACS_Data/ACS_17_5YR_S0101_with_ann.csv")
        over60_2017 <- select(over60_2017, GEO.id2, HC02_EST_VC31)
        over60_2017 <- rename(over60_2017, zipcode = GEO.id2, percent_over60 = HC02_EST_VC31)
        over60_2017 <- over60_2017[2:1942,]
        over60_2017 <- mutate(over60_2017, zipcode = as.numeric(as.character(zipcode)), 
                              percent_over60 = as.numeric(as.character(percent_over60)))
        over60_2017 <- filter(over60_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                           ,78703,78704,78719,78721,78722,78723,78724,78725
                                                           ,78727,78728,78730,78731,78732,78733,78734,78735
                                                           ,78736,78738,78739,78741,78742,78743,78744,78745
                                                           ,78746,78747,78748,78749,78750,78751,78752,78753
                                                           ,78754,78756,78757,78758,78759,78654,78610,78621
                                                           ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
        year2017 <- ymd(20170101)
        over60_2017 <- mutate(over60_2017, date = year2017)
        
#Binding the rows to create one dataset for over 60 years old  
        over60 <- bind_rows(over60_2016, over60_2017)
        over60$percent_over60 <- paste0(over60$percent_over60, '%')
        
#Save R object 
saveRDS(over60, file = "./R Objects/over60.RDS")

```


## Under 6

```{R}
#2016
under6_2016<- read.csv("./ACS_Data/ACS_16_5YR_B09001_with_ann.csv") 
total_pop_2016 <- read.csv("./ACS_Data/ACS_16_5YR_B01003_with_ann.csv") 

names(under6_2016) <- as.matrix(under6_2016[1, ])
under6_2016 <- under6_2016[-1, ]
under6_2016 <- clean_names(under6_2016)
under6_2016 <- rename(under6_2016, zipcode = id2)
under6_2016 <- under6_2016 %>% mutate_each(funs(as.character))
under6_2016 <- under6_2016 %>% mutate_each(funs(as.numeric))
under6_2016 <- filter(under6_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                   ,78703,78704,78719,78721,78722,78723,78724,78725
                                                   ,78727,78728,78730,78731,78732,78733,78734,78735
                                                   ,78736,78738,78739,78741,78742,78743,78744,78745
                                                   ,78746,78747,78748,78749,78750,78751,78752,78753
                                                   ,78754,78756,78757,78758,78759,78654,78610,78621
                                                   ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
names(total_pop_2016) <- as.matrix(total_pop_2016[1, ])
total_pop_2016 <- total_pop_2016[-1, ]
total_pop_2016 <- clean_names(total_pop_2016)
total_pop_2016 <- rename(total_pop_2016, zipcode = id2)
total_pop_2016 <- total_pop_2016 %>% mutate_each(funs(as.character))
total_pop_2016 <- total_pop_2016 %>% mutate_each(funs(as.numeric))
total_pop_2016 <- filter(total_pop_2016, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT

under6_2016 <- select(under6_2016, zipcode, estimate_total, estimate_in_households_under_3_years, 
                      estimate_in_households_3_and_4_years, estimate_in_households_5_years)
under6_2016 <- mutate(under6_2016, children_under6 = estimate_in_households_under_3_years + estimate_in_households_3_and_4_years
                      +estimate_in_households_5_years )
total_pop_2016 <- total_pop_2016 %>% select(zipcode, estimate_total) %>% rename(pop_total = estimate_total) 

under6_2016 <- left_join(under6_2016, total_pop_2016, by = "zipcode")
year2016 <- ymd(20160101)
under6_2016 <- mutate(under6_2016, percent_under6 = children_under6/ pop_total, date = year2016)
under6_2016 <- select(under6_2016, zipcode, children_under6, percent_under6, date)

#2017
under6_2017<- read.csv("./ACS_Data/ACS_17_5YR_B09001_with_ann.csv") 
total_pop_2017 <- read.csv("./ACS_Data/ACS_17_5YR_B01003_with_ann.csv") 

names(under6_2017) <- as.matrix(under6_2017[1, ])
under6_2017 <- under6_2017[-1, ]
under6_2017 <- clean_names(under6_2017)
under6_2017 <- rename(under6_2017, zipcode = id2)
under6_2017 <- under6_2017 %>% mutate_each(funs(as.character))
under6_2017 <- under6_2017 %>% mutate_each(funs(as.numeric))
under6_2017 <- filter(under6_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                   ,78703,78704,78719,78721,78722,78723,78724,78725
                                                   ,78727,78728,78730,78731,78732,78733,78734,78735
                                                   ,78736,78738,78739,78741,78742,78743,78744,78745
                                                   ,78746,78747,78748,78749,78750,78751,78752,78753
                                                   ,78754,78756,78757,78758,78759,78654,78610,78621
                                                   ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 
names(total_pop_2017) <- as.matrix(total_pop_2017[1, ])
total_pop_2017 <- total_pop_2017[-1, ]
total_pop_2017 <- clean_names(total_pop_2017)
total_pop_2017 <- rename(total_pop_2017, zipcode = id2)
total_pop_2017 <- total_pop_2017 %>% mutate_each(funs(as.character))
total_pop_2017 <- total_pop_2017 %>% mutate_each(funs(as.numeric))
total_pop_2017 <- filter(total_pop_2017, zipcode %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT

under6_2017 <- select(under6_2017, zipcode, estimate_total, estimate_in_households_under_3_years, 
                      estimate_in_households_3_and_4_years, estimate_in_households_5_years)
under6_2017 <- mutate(under6_2017, children_under6 = estimate_in_households_under_3_years + estimate_in_households_3_and_4_years
                      +estimate_in_households_5_years )
total_pop_2017 <- total_pop_2017 %>% select(zipcode, estimate_total) %>% rename(pop_total = estimate_total) 

under6_2017 <- left_join(under6_2017, total_pop_2017, by = "zipcode")
year2017 <- ymd(20170101)
under6_2017 <- mutate(under6_2017, percent_under6 = children_under6/ pop_total, date = year2017)
under6_2017 <- select(under6_2017, zipcode, children_under6, percent_under6, date)

#binding rows to create one table for under6
under6 <- bind_rows(under6_2016, under6_2017)
under6$percent_under6 <- percent(under6$percent_under6)

#save R object 
saveRDS(under6, file = "./R Objects/under6.RDS")

```


## Total 211 Calls

```{R}
icarol_2016 <- openxlsx::read.xlsx("./211 Data/2016 CNT iCarol Export.xlsx", sheet = 1, startRow = 1, colNames = TRUE)

#2016renaming column headers and filtering for Travis country zipcodes
icarol_2016 <- clean_names(icarol_2016)

icarol_2016 <- filter(icarol_2016, zip_code
                          %in% c(78705, 78617,78641,78645,78652,78653,78660,78701,78702
                                 ,78703,78704,78719,78721,78722,78723,78724,78725
                                 ,78727,78728,78730,78731,78732,78733,78734,78735
                                 ,78736,78738,78739,78741,78742,78743,78744,78745
                                 ,78746,78747,78748,78749,78750,78751,78752,78753
                                 ,78754,78756,78757,78758,78759,78654,78610,78621
                                 ,78615,78669,78737,78620,78726)) 

icarol_2016 <- filter(icarol_2016, call_type != "Transfer")
icarol_2016 <- filter(icarol_2016, call_type != "Disconnect")
date2016 <- ymd(20160101)
icarol_2016 <- mutate(icarol_2016, date = date2016)


#2016Computing the total number of calls per zipcode along with per 100 households 
calls2016 <- distinct(icarol_2016, call_report_number, .keep_all =  TRUE)
calls2016 <- calls2016 %>% group_by(zip_code) %>% summarise(total_calls = n())
total_housing_units <- read_rds("./R Objects/total_housing_units.RDS")
date2016 <- ymd(20160101)
calls2016 <- mutate(calls2016, date = date2016)
calls2016 <- left_join(calls2016, total_housing_units, by = c("zip_code" = "zipcode", "date"))
calls2016 <- mutate(calls2016, calls_per100HH = total_calls / (housing_units/100) )
calls2016$calls_per100HH<- format(calls2016$calls_per100HH, digits=2, nsmall=2)

#2017
icarol_2017 <- openxlsx::read.xlsx("./211 Data/2017 iCarol Export 1.3.18.xlsx", sheet = 2, startRow = 1, colNames = TRUE)

icarol_2017 <- clean_names(icarol_2017)

icarol_2017 <- filter(icarol_2017, zip_code
                      %in% c(78705,78617,78641,78645,78652,78653,78660,78701,78702
                             ,78703,78704,78719,78721,78722,78723,78724,78725
                             ,78727,78728,78730,78731,78732,78733,78734,78735
                             ,78736,78738,78739,78741,78742,78743,78744,78745
                             ,78746,78747,78748,78749,78750,78751,78752,78753
                             ,78754,78756,78757,78758,78759,78654,78610,78621
                             ,78615,78669,78737,78620,78726)) 

icarol_2017 <- filter(icarol_2017, call_type != "Transfer")
icarol_2017 <- filter(icarol_2017, call_type != "Disconnect")
date2017 <- ymd(20170101)
icarol_2017 <- mutate(icarol_2017, date = date2017)


calls2017 <- distinct(icarol_2017, call_report_number, .keep_all =  TRUE)
calls2017 <- calls2017 %>% group_by(zip_code) %>% summarise(total_calls = n())
total_housing_units <- read_rds("./R Objects/total_housing_units.RDS")
date2017 <- ymd(20170101)
calls2017 <- mutate(calls2017, date = date2017)
calls2017 <- left_join(calls2017, total_housing_units, by = c("zip_code" = "zipcode", "date"))
calls2017 <- mutate(calls2017, calls_per100HH = total_calls / (housing_units/100) )
calls2017$calls_per100HH<- format(calls2017$calls_per100HH, digits=2, nsmall=2)

#Binding the rows to create one dataset for total calls and calls per 100 households 
total_211_calls <- bind_rows(calls2016, calls2017)
total_211_calls <- rename(total_211_calls, zipcode = zip_code)
total_211_calls <- select(total_211_calls, -(housing_units))

#Save R object 
saveRDS(total_211_calls, file = "./R Objects/total_211_calls.RDS")

```

## Data that can be downloaded 

```{R}
#Reading the existing data 
demographics <- read_rds("./R Objects/demographics.RDS")
education_attainment <- read_rds("./R Objects/education_attainment.RDS")
health_insurance <- read_rds("./R Objects/health_insurance.RDS")
median_family_income <- read_rds("./R Objects/median_family_income.RDS")
median_housing_price <- read_rds("./R Objects/median_housing_price.RDS")
median_rent <- read_rds("./R Objects/median_rent.RDS")
over60 <- read_rds("./R Objects/over60.RDS")
percent_below_poverty <- read_rds("./R Objects/percent_below_poverty.RDS")
total_housing_units <- read_rds("./R Objects/total_housing_units.RDS")
under6 <- read_rds("./R Objects/under6.RDS")
total_211_calls <- read_rds("./R Objects/total_211_calls.RDS")

#joining the data
data_4_download <- full_join(demographics, education_attainment, by = c("zipcode", "date"))

data_4_download <- data_4_download %>% full_join(health_insurance, by = c("zipcode", "date")) %>% 
        full_join(median_family_income, by = c("zipcode", "date")) %>% 
        full_join(median_housing_price, by = c("zipcode", "date")) %>% 
        full_join(median_rent, by = c("zipcode", "date")) %>% 
        full_join(over60, by = c("zipcode", "date")) %>% 
        full_join(under6, by = c("zipcode", "date")) %>%
        full_join(percent_below_poverty, by = c("zipcode", "date")) %>% 
        full_join(total_housing_units,by = c("zipcode", "date")) %>% 
        full_join(total_211_calls, by = c("zipcode" , "date")) 

data_4_download <- select(data_4_download, date, zipcode, total_calls, calls_per100HH, everything())
data_4_download <- rename(data_4_download, Year = date)

saveRDS(data_4_download, file = "./R Objects/data_4_download.RDS")

```


## Total 211 Referrals 
```{r}
data <- read_rds("./R Objects/data_4_download.RDS")

summ211data <- data %>% group_by(Year) %>% summarise(total_referrals = sum(total_calls))


saveRDS(data_4_download, file = "./R Objects/summ211.RDS")
```

## Data for use in the app 

```{R}
#reading the existing data 
data <- read_rds("./R Objects/data_4_download.RDS")

convert_columns <- colnames(data[3:24])

data_4_analysis <- reshape(data, idvar = c("Year", "zipcode"), varying = c(convert_columns),
                          v.name = c("value"), times = c(convert_columns),
                          new.row.names = 1:2332, direction = "long")

data_4_analysis <- rename(data_4_analysis, measure = time)

data_4_analysis <- mutate(data_4_analysis, displayed_measure = recode(data_4_analysis$measure, 
                          total_calls = "Total 211 Calls", calls_per100HH = "211 Calls per 100 Households",
                          percent_hispanic = "Hispanic", percent_white_alone = "White", 
                          percent_black_alone = "Black", percent_asian_alone = "Asian",
                          percent_less_than_highschool = "Less than HS", percent_highschool_GED=
                          "HS Diploma or GED", percent_associates_somecollege = "Associates Degree",
                          percent_bachelors_plus = "Bachelor's and Higher", percent_with_insurance =
                          "Insurance", percent_with_private_insurance = "Private Insurance", 
                          percent_with_public_insurance = "Public Insurance", 
                          percent_with_no_insurance= "No Insurance", median_family_income 
                          = "Median Family Income", housing_median_price = "Median Household Value", 
                          estimate_median_gross_rent = "Median Rent", percent_over60 = "Over 60",
                          children_under6 = "Total Children Under 6", percent_below_poverty_level = 
                          "Poverty 100%", 	percent_under6 = "Under 6", housing_units = "Households"
                                          )
                          )

data_4_analysis <- mutate(data_4_analysis, category = recode(data_4_analysis$measure, 
                          total_calls = "211Data", calls_per100HH = "211Data",
                          percent_hispanic = "Race", percent_white_alone = "Race", 
                          percent_black_alone = "Race", percent_asian_alone = "Race",
                          percent_less_than_highschool = "Education", percent_highschool_GED=
                            "Education", percent_associates_somecollege = "Education",
                          percent_bachelors_plus = "Education", percent_with_insurance =
                            "Insurance", percent_with_private_insurance = "Insurance", 
                          percent_with_public_insurance = "Insurance", 
                          percent_with_no_insurance= "Insurance", median_family_income 
                          = "Financial", housing_median_price = "Financial", 
                          estimate_median_gross_rent = "Financial", percent_over60 = "Age",
                          children_under6 = "Age", percent_below_poverty_level = 
                            "Financial", 	percent_under6 = "Age", housing_units = "Households"
                                          )
                          )

  #Adding Geograpic Values
library(sf)
zip <- read_sf(dsn = ".", layer = "tl_2015_us_zcta510")
zip <- filter(zip, GEOID10 %in% c( 78705,78617,78641,78645,78652,78653,78660,78701,78702
                                                         ,78703,78704,78719,78721,78722,78723,78724,78725
                                                         ,78727,78728,78730,78731,78732,78733,78734,78735
                                                         ,78736,78738,78739,78741,78742,78743,78744,78745
                                                         ,78746,78747,78748,78749,78750,78751,78752,78753
                                                         ,78754,78756,78757,78758,78759,78654,78610,78621
                                                         ,78615,78669,78737,78620,78726)) #78712 is excluded,represents UT 

zip <- zip %>% select(GEOID10, geometry) %>% rename(zipcode = GEOID10)

data_4_analysis$zipcode <- as.character(data_4_analysis$zipcode)

data_4_analysis <- left_join(data_4_analysis, zip, by = "zipcode")
data_4_analysis <- rename(data_4_analysis, measures = displayed_measure)
data_4_analysis <- mutate(data_4_analysis, stat = value)
data_4_analysis <- select(data_4_analysis, Year, zipcode, measure, value, stat, 
                          geometry, measures, category)

data_4_analysis$value <- gsub("%", "", data_4_analysis$value)
data_4_analysis$stat <- gsub("%", "", data_4_analysis$stat)
data_4_analysis$value <- as.numeric(data_4_analysis$value)
data_4_analysis$stat <- as.numeric(data_4_analysis$stat)


data_4_analysis <- st_sf(data_4_analysis)


#Save R object 
saveRDS(data_4_analysis, file = "./R Objects/data_4_analysis.RDS")

```
